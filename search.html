<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Government Feedback System - Search</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div class="container mx-auto mt-8 px-4">
        <!-- Search Officials -->
        <div class="bg-white p-8 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-bold mb-4">Search Government Officials</h2>
            <input type="text" id="searchBox" class="w-full p-3 border rounded-md" placeholder="Search by name..." oninput="searchOfficials()">
            <div id="searchResults" class="mt-4 bg-gray-50 p-4 rounded-md space-y-4">
                <!-- Search Results will be dynamically added here -->
            </div>
        </div>

        <!-- Official Details and Feedback -->
        <div id="officialDetails" class="bg-white p-8 rounded-lg shadow-md hidden">
            <!-- Official Info -->
            <div class="flex items-center mb-6">
                <img id="officialPhoto" src="" alt="Official Photo" class="w-16 h-16 rounded-full mr-4">
                <div>
                    <h3 id="officialName" class="text-2xl font-bold"></h3>
                    <p id="officialRating" class="text-sm text-gray-600">Rating: <span id="ratingValue">0</span>/5</p>
                </div>
            </div>

            <!-- Previous Feedbacks -->
            <div id="previousFeedbacks" class="mb-6">
                <h4 class="text-xl font-bold mb-2">Previous Feedbacks</h4>
                <ul id="feedbackList" class="space-y-4 bg-gray-50 p-4 rounded-md">
                    <li class="text-gray-500">Select an official to view feedbacks</li>
                </ul>
            </div>

            <!-- Submit Feedback -->
            <div>
                <h4 class="text-xl font-bold mb-2">Submit Feedback</h4>
                <form id="feedbackForm" class="space-y-6">
                    <div>
                        <label for="category" class="block text-sm font-medium text-gray-700">Feedback Category</label>
                        <select id="category" name="category" class="w-full p-3 border rounded-md">
                            <option value="positive">Positive</option>
                            <option value="moderate">Moderate</option>
                            <option value="rudeness">Rudeness</option>
                            <option value="delay">Delay in Service</option>
                            <option value="inefficiency">Inefficiency</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label for="rating" class="block text-sm font-medium text-gray-700">Rating</label>
                        <input type="number" id="rating" name="rating" min="1" max="5" class="w-full p-3 border rounded-md" placeholder="Rate out of 5" required>
                    </div>
                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-700">Feedback Description</label>
                        <textarea id="description" name="description" rows="4" class="w-full p-3 border rounded-md" placeholder="Describe your experience..." required></textarea>
                    </div>
                    <button type="submit" class="bg-blue-600 text-white w-full py-3 rounded-md hover:bg-blue-700 font-bold">Submit Feedback</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        let currentOfficialId = null;

        async function searchOfficials() {
            const query = document.getElementById('searchBox').value;
            try {
                const response = await fetch(`/api/officials/search?query=${encodeURIComponent(query)}`);
                const officials = await response.json();
                const searchResults = document.getElementById('searchResults');
                searchResults.innerHTML = '';

                officials.forEach(official => {
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'p-3 hover:bg-gray-200 cursor-pointer';
                    resultDiv.innerHTML = `
                        <div class="flex items-center">
                            <img src="${official.photo_url || 'https://via.placeholder.com/150'}" alt="${official.name}" class="w-12 h-12 rounded-full mr-3">
                            <div>
                                <h3 class="font-bold">${official.name}</h3>
                                <p class="text-sm text-gray-600">Position: ${official.position}</p>
                                <p class="text-sm text-gray-600">Rating: ${official.rating.toFixed(1)}/5</p>
                            </div>
                        </div>
                    `;
                    resultDiv.onclick = () => displayOfficialDetails(official);
                    searchResults.appendChild(resultDiv);
                });
            } catch (error) {
                console.error('Error searching officials:', error);
                alert('Error searching officials. Please try again.');
            }
        }

        async function displayOfficialDetails(official) {
            currentOfficialId = official.id;
            document.getElementById('officialDetails').classList.remove('hidden');
            document.getElementById('officialPhoto').src = official.photo_url || 'https://via.placeholder.com/150';
            document.getElementById('officialName').textContent = official.name;
            document.getElementById('ratingValue').textContent = official.rating.toFixed(1);
            
            // Store official ID for feedback submission
            document.getElementById('feedbackForm').dataset.officialId = official.id;

            // Fetch and display previous feedbacks
            await updateFeedbackList(official.id);
        }

        async function updateFeedbackList(officialId) {
            try {
                const response = await fetch(`/api/feedback/${officialId}`);
                const feedbacks = await response.json();
                displayFeedbacks(feedbacks);
            } catch (error) {
                console.error('Error fetching feedbacks:', error);
                document.getElementById('feedbackList').innerHTML = 
                    '<li class="text-gray-500">Error loading feedbacks. Please try again.</li>';
            }
        }

        function displayFeedbacks(feedbacks) {
            const feedbackList = document.getElementById('feedbackList');
            feedbackList.innerHTML = '';

            if (!feedbacks || feedbacks.length === 0) {
                feedbackList.innerHTML = '<li class="text-gray-500">No feedbacks yet</li>';
                return;
            }

            feedbacks.forEach(feedback => {
                const li = document.createElement('li');
                li.className = 'border-b border-gray-200 pb-4 mb-4';
                li.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-grow">
                            <div class="flex items-center mb-2">
                                <p class="font-bold mr-2">${feedback.user_name}</p>
                                <span class="text-sm text-gray-600 bg-gray-200 px-2 py-1 rounded">
                                    ${feedback.category}
                                </span>
                            </div>
                            <p class="text-gray-800 mb-2">${feedback.description}</p>
                            <div class="flex items-center">
                                <div class="flex items-center mr-4">
                                    ${'★'.repeat(feedback.rating)}${'☆'.repeat(5-feedback.rating)}
                                    <span class="ml-1 text-sm text-gray-600">${feedback.rating}/5</span>
                                </div>
                                <p class="text-xs text-gray-500">${feedback.timestamp}</p>
                            </div>
                        </div>
                    </div>
                `;
                feedbackList.appendChild(li);
            });
        }

        document.getElementById('feedbackForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            const officialId = event.target.dataset.officialId;
            const category = document.getElementById('category').value;
            const rating = document.getElementById('rating').value;
            const description = document.getElementById('description').value;

            try {
                const response = await fetch('/api/feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        officialId: parseInt(officialId),
                        category,
                        rating: parseInt(rating),
                        description
                    })
                });

                const data = await response.json();
                if (data.success) {
                    // Clear the form
                    event.target.reset();
                    
                    // Update the feedback list with the new data
                    displayFeedbacks(data.feedbacks);
                    
                    // Refresh the search results to show updated rating
                    await searchOfficials();

                    // Show success message
                    const successMsg = document.createElement('div');
                    successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded shadow-lg';
                    successMsg.textContent = 'Feedback submitted successfully!';
                    document.body.appendChild(successMsg);
                    setTimeout(() => successMsg.remove(), 3000);
                } else {
                    alert('Error submitting feedback. Please try again.');
                }
            } catch (error) {
                console.error('Error submitting feedback:', error);
                alert('Error submitting feedback. Please try again.');
            }
        });

        // Initial search when page loads
        searchOfficials();
    </script>
</body>
</html>
